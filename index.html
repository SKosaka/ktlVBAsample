
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>KTL Learn Advance - VBA入門 ハンズオン手順</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="ktl-learn-advance-vba-"
                  title="KTL Learn Advance - VBA入門 ハンズオン手順"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="はじめに" duration="0">
        <p class="image-container"><img style="width: 601.70px" src="img/c8a2a0e017aa8033.jpeg"></p>
<p>この手順はKTL Learn Advance「Excel VBA入門」にて使用するハンズオン手順です。</p>
<p>この手順は公開しますので復習や展開し自由に使って頂いて構いません。</p>


      </google-codelab-step>
    
      <google-codelab-step label="初期設定① - 開発タブの表示" duration="0">
        <ol type="1" start="1">
<li>新規Excelブックを作成</li>
<li>「ファイル」→「名前を付けて保存」を選択</li>
<li>好きな場所に「テストアプリ.xlsm」と保存<br>※このとき、必ず「ファイルの種類」を「Excelマクロ有効ブック(*.xlsm)」にすること</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/2269a48acf4cbc93.png"></p>
<ol type="1" start="4">
<li>「ファイル」→「オプション」を選択</li>
<li>「リボンのユーザー設定」→「開発」にチェック</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/cd271058441277d0.png"></p>
<ol type="1" start="6">
<li>「OK」を選択</li>
<li>タブに「開発」と表示されていることを確認する</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/74085fdae90e86f7.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="初期設定② - VBEの初期設定" duration="0">
        <ol type="1" start="1">
<li>「開発」タブを開く</li>
<li>「Visual Basic」を選択し、VBE(Visual Basic Editor)を開く</li>
</ol>
<aside class="special"><p>VBEは<code>Alt</code>+<code>F11</code>でも開くことができます。<br>このハンズオンでは以降、VBEを開く動作は<code>Alt</code>+<code>F11</code>と表記します。</p>
</aside>
<ol type="1" start="3">
<li>「ツール」→「オプション」を開く</li>
<li>「編集」タブ内(最初から開かれているタブ)の「変数の宣言を強制する」にチェックを入れる</li>
</ol>
<p class="image-container"><img style="width: 377.67px" src="img/a2aedc1a3cb1582.png"></p>
<ol type="1" start="5">
<li>「OK」を選択</li>
<li>VBEの画面左上の領域(「プロジェクトウィンドウ」という)上で右クリック→「挿入」→「標準モジュール」と選択</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/aa24bb50befabb99.png"></p>
<ol type="1" start="7">
<li>画面右側の入力用のウィンドウ(コードウィンドウ)の一番最初に「Option Explicit」と書かれていれば初期設定は完了</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/b478e7a7e055d2cc.png"></p>


      </google-codelab-step>
    
      <google-codelab-step label="初めてのVBAプログラムを動かしてみる" duration="0">
        <ol type="1" start="1">
<li>コードウィンドウの<code>Option Explicit</code>の次の行に<code>sub Test</code>と入力し、<code>Enter</code>キーを押下する</li>
<li>すると自動的に<code>sub</code>が<code>Sub</code>と変換され、<code>Test</code>の後ろに<code>()</code>が追記される。また、<code>End Sub</code>と表示される</li>
</ol>
<aside class="special"><p><code>Sub XX</code> から始まり、<code>End Sub</code>で終わるまとまりのことを「Subプロシージャ」といいます。</p>
<p>「プロシージャ」はプログラムのまとまりを示すもので、Excelは呼び出されたプロシージャに書かれた命令文を順番に実行していきます。</p>
<p>なお、プロシージャには他にも「Functionプロシージャ」というものもありますが、こちらは後述します。</p>
</aside>
<ol type="1" start="3">
<li><code>Sub Test()</code>以下を次のように記述する</li>
</ol>
<pre>Sub Test()

  MsgBox &#34;これはテストです&#34;

End Sub</pre>
<aside class="warning"><p>※VBAでは一つの命令文を一行で入力します。基本的に文中での改行はできません(方法はありますがここでは触れません)。</p>
<p>※行間の改行は自由に挿入できます。ここでも見やすくするために入れています。</p>
<p>※VBAではコードを見やすくするために適宜<code>Tab</code>を挿入します。この場合、<code>MsgBox</code>の手前にTabをひとつ挿入します。</p>
<p>※VBAの中で予め定義されている関数等の入力は適宜補完されます。例えば小文字で<code>msgbox</code>と入力しても、入力後に<code>MsgBox</code>と自動変換されます。また、同様にスペースも必要に応じて追加されます。</p>
</aside>
<aside class="special"><p><code>MsgBox</code>は、メッセージボックスを表示する関数です。</p>
<p>本日ご紹介するのはシンプルな書き方ですが、様々な引数を組み合わせるなどすることで多彩な表現が可能です。</p>
<p>「Excel VBA MsgBox」などと検索すると以下のようなページなど多数のTipsがヒットしますので、詳しくはご自身で検索してみてください。</p>
<p><a href="https://www.moug.net/tech/exvba/0100033.html" target="_blank">https://www.moug.net/tech/exvba/0100033.html</a></p>
</aside>
<ol type="1" start="4">
<li>作成したプログラムを実行し動作を確認するため、<code>Sub Test()</code>と<code>End Sub</code>の間のどこかをクリックしカーソルを置く</li>
<li><code>F5</code>キーを押下する</li>
<li>画面に「これはテストです」というメッセージボックスが表示されたことを確認し、「OK」ボタンを押下する</li>
</ol>
<p class="image-container"><img style="width: 192.65px" src="img/562de6205cdf882e.png"></p>
<h2 is-upgraded>様々な動かし方を試してみる ①ステップイン</h2>
<ol type="1" start="7">
<li>先ほど作成したコードを以下のように書き換える</li>
</ol>
<pre>Sub Test()

  Dim testString as String
  testString = &#34;これはテストです。実施日時は&#34; &amp; Now() &amp; &#34;です&#34;
  MsgBox testString

End Sub</pre>
<aside class="special"><p><code>Dim ooo as xxx</code> で「変数」を宣言します。</p>
<p>「変数」とは、状態などによって変化する文字列や値を格納する箱のようなものです。</p>
<p>oooの部分が変数の名前(変数名)、xxxの部分が「型」と言って、どういった内容の情報を入れるのかを定義する部分になります。</p>
<p>変数名は基本的に任意の名前を付けることができますが、留意点として(少し雑な説明になってしまいますが)「同じプログラムの中で使っている変数名と、既に内部的に用意されている変数名は使えない」とまずは覚えておけばよいかと思います。</p>
<p>型については、例えば「文字列」を入れる箱を用意するとそこに入れた数字は数値として扱うことはできない、などといった制約が発生したりします。</p>
<p>今回は詳しく説明しませんが、詳しくは「VBA 変数 型」などと検索し、以下のようなページを参考にご自身でご確認ください。<br><a href="https://www.officepro.jp/excelvba/basic/index4.html" target="_blank">https://www.officepro.jp/excelvba/basic/index4.html</a></p>
</aside>
<ol type="1" start="8">
<li>4と同様に、カーソルを<code>Sub</code>プロシージャ内に置き、<code>F8</code>キーを押下する</li>
<li><code>Sub Test()</code>が黄色くハイライトされる</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/13703507fa7ee92a.png"></p>
<ol type="1" start="10">
<li>再度<code>F8</code>キーを押下すると、<code>testString = ..."</code> の行にハイライトが移動する</li>
<li>更に<code>F8</code>キーを押下すると、<code>MsgBox testString</code>の行にハイライトが移動する。このとき<code>testString</code>にカーソルを合わせると、<code>testString</code>の内容を確認することができる。</li>
<li>もう一度<code>F8</code>キーを押下すると、メッセージボックスが表示される</li>
</ol>
<p class="image-container"><img style="width: 333.00px" src="img/2eca87a8b4f387f6.png"></p>
<ol type="1" start="13">
<li>メッセージボックスの「OK」を押下すると、<code>End Sub</code>の行がハイライトされている。更に<code>F8</code>キーを押下するとハイライトが消える</li>
</ol>
<aside class="special"><p>ここで行ったのが「ステップイン」という実行方法です。</p>
<p>ステップインではプログラムを一行ずつ実行していきます。</p>
<p>想定した順序で実行されているかや、どこでエラーが起こっているかが明確でなく一行ずつ確認したい場合などに使います。</p>
<p>なお、変数など宣言に関する部分は飛ばされます(実行はされています)。</p>
</aside>
<h2 is-upgraded>様々な動かし方を試してみる ②ブレイクポイント</h2>
<ol type="1" start="14">
<li><code>MsgBox (testString)</code>の行にカーソルを置き、<code>F9</code>キーを押下する</li>
<li>すると、カーソルを置いた業が褐色にハイライトされる</li>
</ol>
<p class="image-container"><img style="width: 601.70px" src="img/f7f03c74489470b4.png"></p>
<ol type="1" start="16">
<li><code>F5</code>キーを押下する</li>
<li>褐色にハイライトされた行が黄色くハイライトされる</li>
<li>もう一度<code>F5</code>キーを押下するとメッセージボックスが表示される</li>
<li>メッセージボックスの「OK」を押下すると、黄色いハイライトは消える</li>
</ol>
<aside class="special"><p>ここで設置した褐色のハイライト部分を「ブレイクポイント」と呼びます。</p>
<p>プログラムを実行した際、ブレイクポイントを設定している箇所で処理を止めることができます。</p>
<p>ステップインと同様、プログラムの内容を確認するときに用います。</p>
<p>なお、ブレイクポイントは、設定したい行の左側(上記画像の●印付近)を押下することでも設定することができます。</p>
</aside>


      </google-codelab-step>
    
      <google-codelab-step label="差込印刷アプリを触ってみる" duration="0">
        <ol type="1" start="1">
<li>「ハンズオン用資材」のフォルダ配下は以下のとおり</li>
</ol>
<pre>・PDFフォルダ ... プログラム実行により作成されたPDFファイルを格納
・差込印刷アプリ(完成版).xlsm ... ハンズオンの完成物の見本
・差込印刷アプリ.xlsm ... ハンズオン用ファイル(プログラム部分は空)</pre>
<ol type="1" start="2">
<li>「差込印刷アプリ(完成版).xlsm」を開く</li>
</ol>
<aside class="warning"><p>「インターネット上の場所から取得されており、安全でない可能性があります」という警告文が表示された場合は「編集を有効にする」を選択してください。</p>
<p>「セキュリティの警告...」という警告文が表示された場合は「マクロを有効にする」を選択してください。</p>
<p>なお、セキュリティの警告が表示されるのは、VBAがコンピュータウイルスにも悪用できてしまうためです。作成元が不明のマクロを含むファイルは開かない、マクロを有効にしないことを心がけてください。</p>
</aside>
<ol type="1" start="3">
<li>「納入通知書」「差し込みリスト」の2シートがある<br>今回のプログラムでは「差し込みリスト」のK列「引抜」セルが空欄の行の対象者の情報を「納入通知書」シートに転記しPDF化又は印刷する。なお「納入通知書」シートの差込箇所にあたる部分は便宜上褐色に色付けしている</li>
<li>「納入通知書」シート上「印刷」ボタンを選択</li>
<li>暫く待つと「差し込み完了しました」というメッセージボックスが表示される</li>
<li>「OK」押下後、PDFフォルダを確認すると2つのPDFファイルが出力されていることが確認できる</li>
<li>「差込印刷アプリ(完成版).xlsm」に戻り<code>Alt</code>+<code>F11</code>キーでVBEを開くと完成版のコードとコメントを確認できる</li>
</ol>
<aside class="special"><p>「<code>'</code>」(シングルクォーテーション)を付けた以降の記述は全てコメントとなり、ソースコードとしては扱われません。</p>
<p>作成意図や修正履歴などをコメントとして残しておくことで作成してから時間が経っても忘れにくくなることに加え、他者がコードを読む際の理解を助けることにも繋がります。</p>
<p>なお、ソースコードの先頭に「<code>'</code>」を付け動作しないようにすることを「コメントアウト」と呼びます。</p>
</aside>
<ol type="1" start="8">
<li>「差込印刷アプリ(完成版).xlsm」を閉じる</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="差込印刷アプリを作ってみる①" duration="0">
        <h2 is-upgraded>タイトル行の項目名の変数化</h2>
<ol type="1" start="1">
<li>「差込印刷アプリ.xlsm」を開き、<code>Alt</code>+<code>F11</code>キーでVBEを開く</li>
<li>VBEのプロジェクトウィンドウ上で右クリック→「挿入」→「標準モジュール」と選択</li>
<li><code>Option Explicit</code>の下に以下のように記述する</li>
</ol>
<pre>Option Explicit

Private Enum HEADER
  No = 1
  郵便番号
  住所
  氏名
  発行日
  納入対象年
  納入対象月
  手数料A
  手数料B
  納入期日
  引抜
End Enum</pre>
<aside class="warning"><p>ここでは<code>End Enum</code>が自動記述されないので注意しましょう。</p>
</aside>
<aside class="special"><p>ここでは「差し込みリスト」のヘッダー行(タイトル行)の各項目名を変数名として定義し、そこに行番号を格納しています。</p>
<p>ここで使う<code>Enum</code>のことは「列挙型変数」と呼び、その名のとおり、列挙していくような事柄(今回ならヘッダーの各項目)を変数にする場合に用います。</p>
<p>使い方としては、<code>Private Enum HEADER</code> 〜 <code>End Enum</code>の間に、No、郵便番号、住所...と列名を順に変数名として定義していきます。</p>
<p>最初の変数であるNoに<code>1</code>を代入すると、郵便番号以下は1ずつ加えた値が格納されていきます(郵便番号<code>=2</code>、住所<code>=3</code>...)。</p>
<p>なお、Noに明示的に値を代入しない場合は自動的に<code>0</code>が代入されます。</p>
<p>今回はNoに<code>1</code>を代入することで、結果的に列番号相当の値が格納できたことになります。</p>
</aside>
<h2 is-upgraded>繰り返し処理</h2>
<ol type="1" start="4">
<li>次に以下のように記述する</li>
</ol>
<pre>Public Sub 差し込み印刷()

  Dim lr As ListRow
  For Each lr In 差し込みリスト.ListObjects(&#34;T_差し込みリスト&#34;).ListRows

    MsgBox &#34;今は&#34; &amp; lr.Index &amp; &#34;行目を処理中&#34;

  Next lr

  Msgbox &#34;差し込み完了しました&#34;

End Sub</pre>
<aside class="special"><p><code>Dim lr as ListRow</code>では変数を定義しています</p>
<p>ここでは「差し込みリスト」シートにあるテーブル(T_差し込みリスト)を一行ずつ処理していくため、処理する行の番号を変数<code>lr</code>に格納していきます。</p>
</aside>
<aside class="special"><p>一行ずつ処理するために繰り返しの処理を入れます。</p>
<p>ここでは<code>For Each 〜 Next lr</code>の部分です。</p>
<p><code>For Each</code> (変数名) <code>In xxx</code> では、<code>xxx</code> の処理結果を変数に格納し、以降の処理に渡しています。</p>
<p><code>xxx</code> の部分が繰り返しの要素となり、全てのパターンを変数に渡し切るまで処理を繰り返します。</p>
<p>例えば、<code>For Each rng In Range("A1:A10")</code>なら、<code>A1</code>〜<code>A10</code>のセルの値を変数<code>rng</code>に順番に格納し処理するという意味になります。</p>
<p>上記コードの差し込みリスト<code>.ListObjects("</code>差し込みリスト<code>").ListRows</code>は、「差し込みリスト」シートにあるテーブル(T_差し込みリスト)を指しており、同テーブルを一行ずつ処理していくという意味になります。</p>
<p>なお、今回は差し込みリストをテーブルとしています。</p>
<p>テーブルにすることで一行の列範囲を指定する必要がないなど、可読性(読みやすさ)や保守性(改修等のしやすさ)が向上するというメリットがあります。</p>
<p class="image-container"><img style="width: 587.00px" src="img/8b9ac137a3c0a6aa.png"></p>
<p>↑テーブルにした場合の<code>ListRows</code>と<code>ListRow</code>の関係(イメージ)</p>
</aside>
<aside class="special"><p>「差込印刷アプリ(完成版).xlsm」のコードのコメント部分に<code>For Each</code>以外の繰り返し文について少し触れています。</p>
</aside>
<h2 is-upgraded>動作確認</h2>
<ol type="1" start="5">
<li>「差し込み印刷」プロシージャ内をクリックしてカーソルを置き、F5キーを押下</li>
<li>「今は1行目を処理中」と表示される。「OK」ボタンまたはEnterキーを押下すると次は「今は2行目を処理中」と表示される。これを合計7回(nの部分が1〜7まで増えていきながら)表示された後「差し込み完了しました」と表示され処理が終了する</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="差込印刷アプリを作ってみる②" duration="0">
        <h2 is-upgraded>条件分岐(If文)</h2>
<ol type="1" start="1">
<li>差し込み印刷プロシージャーの<code>For Each</code>文内を以下のように書き換える</li>
</ol>
<pre>Public Sub 差し込み印刷()

  Dim lr As ListRow
  For Each lr In ThisWorkbook.Worksheets(&#34;差し込みリスト&#34;).ListObjects(&#34;T_差し込みリスト&#34;).ListRows
    
    If lr.Range(引抜).Value = &#34;&#34; Then
       MsgBox &#34;今は&#34; &amp; lr.Index &amp; &#34;行目を処理中&#34;
    End If

  Next lr

  Msgbox &#34;差し込み完了しました&#34;

End Sub</pre>
<aside class="special"><p>条件によって処理を振り分ける場合は<code>If (</code>条件<code>) Then</code>と書きます。</p>
<p>例えば <code>If x>1 then</code>なら、「もし(変数)<code>x</code>が1より大きい場合」という条件になります。</p>
<p>※条件に一致/不一致だった場合の処理については後述します。</p>
</aside>
<aside class="special"><p>ここで追加した<code>If lr.Range(</code>引抜<code>).Value = "" Then</code>についてですが、</p>
<p>まず変数<code>lr</code>は「差し込みリスト」シートにある「T_差し込みリスト」テーブルの指定行(1〜7行目のいずれか)を指していました。</p>
<p>その後ろの<code>.Range(</code>引抜<code>)</code>は「引抜」列を示しています。</p>
<p>なお、アプリを作成し始めた際にタイトル行の項目名を変数化しています。</p>
<p>よって「引抜」は変数で、ここにはその際に格納した列番号<code>11</code>が格納されています</p>
<p>(つまり正確には<code>.Range(11)</code>)。</p>
<p><code>.Range(</code>引抜<code>).Value=""</code> で指定行の「引抜」列に該当するセルの値が「空」である、という意味になりますので、ここでは『「差し込みリスト」シートの「T_差し込みリスト」テーブルの指定行の「引抜」列に該当するセルの値が空の場合』という意味になります。</p>
</aside>
<h2 is-upgraded>動作確認</h2>
<ol type="1" start="2">
<li>「差し込み印刷」プロシージャ内をクリックしてカーソルを置き、<code>F5</code>キーを押下</li>
<li>「今は1行目を処理中」と表示される。「OK」ボタンまたは<code>Enter</code>キーを押下すると次は「今は2行目を処理中」と表示された後「差し込み完了しました」と表示され処理が終了する</li>
</ol>
<aside class="special"><p>追加したIF文により「T_差し込みリスト」テーブルの「引抜」列が空欄の行のみ処理され、その結果上述3.のような結果となりました。</p>
</aside>
<h2 is-upgraded>IF文補足</h2>
<p>条件分岐の書き方は他にもあります。ここではその一例を紹介します。</p>
<pre>‘他の条件が存在する または その条件のどれにも当てはまらない場合の書き方
If x &gt; 1 then
  MsgBox &#34;xは1より大きい&#34;
Else If x &gt; 10 then
  MsgBox &#34;xは10より大きい&#34;
Else
  MsgBox &#34;xは1より小さい&#34;
End If

‘Not演算子を使った書き方
If not x &gt; 1 then ‘もしxが1より大きくない場合

‘複数の条件を満たす必要がある場合の書き方
If x &gt; 1 And y &gt; 10 then ‘もしxは1以上、yは10以上の場合

‘条件が一通りのみの場合は一行でその後の処理まで書ける
If x &gt; 1 then MsgBox &#34;xは1より大きい&#34;</pre>


      </google-codelab-step>
    
      <google-codelab-step label="差込印刷アプリを作ってみる③" duration="0">
        <h2 is-upgraded>納入通知書への転記処理を追加する</h2>
<aside class="special"><p>一連の処理は1つのプロシージャ(<code>Sub</code>または<code>Function</code>)へまとめると可読性や保守性が上がります。</p>
<p>注意点としては1つのプロシージャには1つの機能だけを持たせるようにするということです。</p>
<p>例えば、ここから記述するのは「T_差し込みリスト」を1行ずつ通知書へ転記するプロシージャです。</p>
<p>同じプロシージャに印刷などいろいろな機能を追加しないようにしましょう。</p>
</aside>
<ol type="1" start="1">
<li>納入通知書への情報の転記処理を追加するため、以下の記述を差し込み印刷プロシージャの下に追記する</li>
</ol>
<pre>Private Sub 納入通知書転記(ByRef list_row As ListRow)
  納入通知書.Range(&#34;No&#34;).Value = list_row.Range(No).Value
  納入通知書.Range(&#34;郵便番号&#34;).Value = list_row.Range(郵便番号).Value
  納入通知書.Range(&#34;住所&#34;).Value = list_row.Range(住所).Value
  納入通知書.Range(&#34;氏名1&#34;).Value = list_row.Range(氏名).Value &amp; &#34; 様&#34;
  納入通知書.Range(&#34;発行日&#34;).Value = list_row.Range(発行日).Value
  納入通知書.Range(&#34;氏名2&#34;).Value = list_row.Range(氏名).Value &amp; &#34; 様&#34;
  納入通知書.Range(&#34;手数料A&#34;).Value = list_row.Range(手数料A).Value
  納入通知書.Range(&#34;手数料B&#34;).Value = list_row.Range(手数料B).Value
  納入通知書.Range(&#34;納入期日&#34;).Value = list_row.Range(納入期日).Value

  Dim targetYear As Long
  targetYear = list_row.Range(納入対象年).Value
  Dim targetMonth As Long
  targetYear = list_row.Range(納入対象月).Value
  Dim script As String
  script = &#34;令和&#34; &amp; targetYear &amp; &#34;年&#34; &amp; targetMonth &amp; &#34;月分（1日～末日）の手数料として、同封の納入通知書により下記指定期日までに下記
の金額を納入されたい。&#34;
  納入通知書.Range(&#34;頭書き&#34;).Value = script

End Sub</pre>
<aside class="special"><p>冒頭の<code>(ByRef list_row As ListRow)</code>については呼び出し元から渡された値など(引数)です。この場合、「差し込みリスト」シート内「T_差し込みリスト」テーブルの指定行の番号が入ってくる想定で、その行番号に対応する内容を「納入通知書」シートに転記します。</p>
</aside>
<aside class="special"><p>通常、セルを指定する場合は<code>Range(A1)</code>や<code>Cells(1,1)</code>と記述します。</p>
<p>今回は予めセルそのものの名前を変更し(以下画像参照)、<code>.Range("</code>セルの名前<code>").Value</code>と表記しています。こうすることで、セルの指定を容易にし、可読性と保守性を向上させています。</p>
<p class="image-container"><img style="width: 587.00px" src="img/d02a13f4092621f9.png"></p>
<p>少しややこしいですが、同じ行の後段、<code>list_row.Range(xxx).Value</code>については、<code>xxx</code>の部分が列番号を格納した変数となっています。詳しくは「差込印刷アプリを作ってみる②」の「条件分岐(If文)」を参照ください。</p>
</aside>
<ol type="1" start="2">
<li>「差し込み印刷」プロシージャから「納入通知書転記」プロシージャを呼び出すため、「差し込み印刷」プロシージャの<code>If</code>文内を以下のとおり修正する</li>
</ol>
<pre>Public Sub 差し込み印刷()

  Dim lr As ListRow
  For Each lr In ThisWorkbook.Worksheets(&#34;差し込みリスト&#34;).ListObjects(&#34;T_差し込みリスト&#34;).ListRows
    
    If lr.Range(引抜).Value = &#34;&#34; Then
       Call 納入通知書転記(lr)
    End If

  Next lr

  Msgbox &#34;差し込み完了しました&#34;

End Sub</pre>
<aside class="special"><p>ここでは先ほど作成した「納入通知書転記」関数を呼び出しています。</p>
<p>呼び出す際は<code>Sub</code>プロシージャの前に<code>Callを付けて</code>呼び出します。</p>
<p>(なくても呼び出せますが、混乱の元となるため必ずつけるようにしましょう)</p>
</aside>
<h2 is-upgraded>動作確認</h2>
<ol type="1" start="3">
<li>今回はステップインで一行ずつ処理を確認するので、「差し込み印刷」プロシージャ内をクリックしてカーソルを置き、<code>F8</code>キーを押下</li>
<li>先ほど追記した<code>Call</code> 納入通知書転記<code>(lr)</code>の箇所にきた後、「納入通知書転記」プロシージャにハイライトが移動していることがわかる</li>
<li>納入通知書転記 <code>= True</code>まで処理が進んだらExcelシートを確認</li>
<li>差し込みリストの最初の人の情報がExcelシートに転記されている</li>
<li>処理が終了するまで<code>F8</code>を繰り返し押下する(<code>F5</code>で一気に終わらせてもよい)</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="差込印刷アプリを作ってみる④" duration="0">
        <h2 is-upgraded>出力処理を追加する</h2>
<ol type="1" start="1">
<li>PDF又は紙への出力処理を追加するため、「納入通知書転記」プロシージャの後に以下を追記</li>
</ol>
<pre>Private Sub 納入通知書出力(ByVal mode As String, ByRef list_row As ListRow)
  Select Case mode
    Case &#34;PDF&#34;, &#34;pdf&#34;, &#34;P&#34;, &#34;p&#34;
    Dim pdfName As String
    pdfName = Format(list_row.Range(No).Value, &#34;00&#34;) &amp; &#34;_納入通知書_&#34; &amp; list_row.Range(氏名).Value &amp; &#34;.pdf&#34;
    納入通知書.ExportAsFixedFormat Type:=xlTypePDF, Filename:=ThisWorkbook.Path &amp; &#34;\PDF\&#34; &amp; pdfName
  Case Else
    納入通知書.PrintOut preview:=True
  End Select
End Sub</pre>
<aside class="special"><p>冒頭<code>(ByVal mode As String, ByRef list_row As ListRow)</code> の<code>mode</code>の部分でPDF出力か印刷かを判断するための材料(文字情報)を受け取ります。ここでは<code>"PDF", "pdf", "P", "p"</code>のいずれかが<code>mode</code>に渡されたらPDF出力、それ以外の場合は印刷という仕様にしています。</p>
</aside>
<aside class="special"><p>条件分岐式としてCase文を使用しています。</p>
<p>If文よりも複数条件時の記述が少なくて済みます。</p>
<p>記述方法としては以下のとおりです。</p>
</aside>
<pre>Select Case mode
  Case 条件1, 条件2, 条件3..
    (処理)
  Case Else
    (処理)
End Select</pre>
<aside class="special"><p>特定のシートをPDFとしてエクスポートする場合は以下のとおり記述します。</p>
<p><code>ThisWorkbook.Worksheets("</code>出力するシート名<code>").ExportAsFixedFormat Type:=xlTypePDF, Filename:=</code> 出力先のフルパス <code>+</code> 出力ファイル名</p>
<p>また、出力したPDFファイルを開く場合の記述方法は以下のとおりです。</p>
<p><code>CreateObject("Wscript.shell").Run 出力先のフルパス + 出力ファイル名</code></p>
</aside>
<aside class="special"><p>特定のシートを印刷する場合は以下のとおり記述します。</p>
<p><code>ThisWorkbook.Worksheets("</code>出力するシート名<code>").PrintOut preview:=True</code></p>
<p><code>preview:=True</code>の場合は印刷プレビューを表示、<code>preview:=False</code>の場合はそのまますぐに印刷される</p>
</aside>
<ol type="1" start="2">
<li>「差し込み印刷」プロシージャから「納入通知書出力」プロシージャを呼び出すため、「差し込み印刷」プロシージャのIf文内を以下のとおり修正する</li>
</ol>
<pre>Public Sub 差し込み印刷()

  Dim lr As ListRow
  For Each lr In ThisWorkbook.Worksheets(&#34;差し込みリスト&#34;).ListObjects(&#34;T_差し込みリスト&#34;).ListRows
    
    If lr.Range(引抜).Value = &#34;&#34; Then
       Call 納入通知書転記(lr)
       Call 納入通知書出力(&#34;pdf&#34;, lr)
    End If

  Next lr

  Msgbox &#34;差し込み完了しました&#34;

End Sub</pre>
<h2 is-upgraded>動作確認</h2>
<ol type="1" start="3">
<li>「PDF」フォルダの中身を全て削除する</li>
<li>「差し込み印刷」プロシージャ内をクリックしてカーソルを置き、<code>F5</code>キーを押下</li>
<li>「差し込み完了しました」とのメッセージボックスの表示を確認後「PDF」フォルダを確認すると、「T_差し込みリスト」上引抜になっていない対象者の納入通知書が出力されていることが確認できる</li>
</ol>


      </google-codelab-step>
    
      <google-codelab-step label="差込印刷アプリを作ってみる⑤" duration="0">
        <h2 is-upgraded>ボタンからプログラムを起動できるようにする</h2>
<ol type="1" start="1">
<li>「納入通知書」シート上の「印刷」ボタン(というか図形)上で右クリック→「マクロの登録」を選択</li>
</ol>
<p class="image-container"><img style="width: 247.78px" src="img/be997082d9415182.png"></p>
<ol type="1" start="2">
<li>表示された画面で「差し込み印刷」を選択し、「OK」を押下</li>
</ol>
<p class="image-container"><img style="width: 387.00px" src="img/986afad5baef82c3.png"></p>
<ol type="1" start="3">
<li>「印刷」ボタンを押すことで今回作成したプログラムが起動するようになる</li>
</ol>
<aside class="special"><p>ここで選択できるのは<code>Sub</code>または<code>Public Sub</code>から始まる<code>Sub</code>プロシージャのみです。</p>
<p><code>Private Sub</code>や<code>Function</code>などのプロシージャは選択できません。</p>
<p>なお、上述作業でボタン等とプロシージャを紐付けたあと、<code>Public</code>→<code>Private</code>に書き換えることは可能です。</p>
<p><code>Sub</code>や<code>Public Sub</code>のプロシージャは「開発」タブ→「マクロ」から呼び出すことも可能なので、想定外の方法で呼び出されることを避けたい場合などは<code>Private</code>にすることで前述の方法での呼び出しができないようにします。</p>
</aside>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
